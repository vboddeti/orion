name: Build and Publish

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: write

jobs:
  # In order to build general manylinux wheels that support older Linux
  # distributions, we'll need to use Docker. 
  build-manylinux:
    runs-on: ubuntu-latest
    container:
      image: quay.io/pypa/manylinux_2_28_x86_64
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    steps:
      - name: checkout repository
        uses: actions/checkout@v4
            
      - name: build in docker
        uses: ./.github/actions/build-manylinux
        with:
          python-version: ${{ matrix.python-version }}

      - name: upload linux wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-manylinux2014-py${{ matrix.python-version }}-x64
          path: wheelhouse/*.whl

  # For all other operating systems we support (Windows, macOS Intel (x64)
  # and macOS Apple Silicon (arm64)) we can use the default machines GitHub 
  # Actions provides
  build-other:
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - {os: windows-latest, arch: "x64"}
          - {os: macos-latest, arch: "arm64"}
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    
    steps:
      - name: checkout orion repository
        uses: actions/checkout@v4

      # Conda is necessary here else we can't build MacOS arm64 on 
      # Python versions < 3.11.
      - name: setup python
        uses: conda-incubator/setup-miniconda@v2
        with:
          miniconda-version: "latest"
          python-version: ${{ matrix.python-version }}
          architecture: ${{ matrix.config.arch }}
          auto-activate-base: true
      
      - name: set up golang
        uses: actions/setup-go@v5
        with:
          go-version: '1.21.x'
      
      - name: build wheels
        shell: bash -l {0}
        run: |
          pip install poetry
          poetry build

          echo "Contents of the wheel file:"
          unzip -l dist/*.whl

      - name: upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.config.os }}-py${{ matrix.python-version }}-${{ matrix.config.arch }}
          path: dist/*.whl

  # Now we can test the wheels we just created. We'll do this by downloading
  # all wheels that were added as artifacts in the previous build jobs.
  test:
    needs: [build-manylinux, build-other]
    runs-on: ${{ matrix.config.os }}
    strategy:
      fail-fast: false
      matrix:
        config:
          - {os: ubuntu-latest, arch: "x64"}
          - {os: windows-latest, arch: "x64"}
          - {os: macos-latest, arch: "arm64"}
        python-version: ["3.9", "3.10", "3.11", "3.12"]
    
    steps:
      - name: checkout orion repository
        uses: actions/checkout@v4
      
      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          architecture: ${{ matrix.config.arch }}

      - name: select wheel artifact for this runner
        shell: bash
        run: |
          if [[ "${{ matrix.config.os }}" == "ubuntu-latest" ]]; then
            echo "WHEEL_ARTIFACT=wheels-manylinux2014-py${{ matrix.python-version }}-x64" >> $GITHUB_ENV
          elif [[ "${{ matrix.config.os }}" == "windows-latest" ]]; then
            echo "WHEEL_ARTIFACT=wheels-windows-latest-py${{ matrix.python-version }}-${{ matrix.config.arch }}" >> $GITHUB_ENV
          else
            echo "WHEEL_ARTIFACT=wheels-${{ matrix.config.os }}-py${{ matrix.python-version }}-${{ matrix.config.arch }}" >> $GITHUB_ENV
          fi

      - name: download artifact wheels
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.WHEEL_ARTIFACT }}
          path: dist/

      - name: gather wheels into single directory
        shell: bash
        run: |
          mkdir -p merged-wheels
          find dist -name "*.whl" -exec cp {} merged-wheels/ \;
          ls -l merged-wheels
            
      - name: install packages
        shell: bash
        run: |
          # Install test deps and runtime deps from PyPI (PyTorch from CPU index), then our wheel only from artifacts
          pip install pytest pytest-cov
          pip install --extra-index-url https://download.pytorch.org/whl/cpu \
            PyYAML torch torchvision tqdm numpy scipy matplotlib h5py certifi
          pip install --no-index --find-links=merged-wheels --no-deps orion-fhe

      - name: run pytest
        shell: bash 
        run: |
          # Create temp directory
          cd $RUNNER_TEMP
          echo "Testing from directory: $RUNNER_TEMP"
          python -m pytest $GITHUB_WORKSPACE/tests/

  publish:
    needs: [test]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: checkout repository
        uses: actions/checkout@v4

      - name: set up python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      
      - name: download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist/
          merge-multiple: true
      
      - name: publish to pypi
        run: |
          pip install poetry
          poetry config pypi-token.pypi ${{ secrets.PYPI_API_TOKEN }}
          poetry publish --skip-existing
